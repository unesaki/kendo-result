= 団体戦結果登録API 処理詳細設計書

== 対象API
POST /api/team-matches

== 概要
団体戦の試合結果を登録するAPI。
1つの団体戦は5人制（先鋒〜大将）で構成され、各試合の勝敗を含めて1リクエストで登録する。

== Bean定義

=== 種別一覧

[cols="1,1,2", options="header"]
|===
| 種別 | 名称                        | 補足

| DTO  | CreateTeamMatchRequestDto   | 団体戦試合登録リクエストDTO
| DTO  | CreateTeamMatchResponseDto  | 登録完了時レスポンスDTO
| Entity | TeamMatchEntity           | 団体戦全体の情報
| Entity | TeamMatchDetailEntity     | 各ポジションごとの試合結果（5件）
|===

=== CreateTeamMatchRequestDtoのフィールド定義

[cols="1,1,1,1", options="header"]
|===
| 論理名 | 物理名 | 型 | バリデーションルール

| 大会ID | tournamentId | Long | 必須
| ラウンド名 | roundName | String | 必須（例: "1回戦"）
| 赤チーム名 | redTeamName | String | 必須、最大50文字
| 白チーム名 | whiteTeamName | String | 必須、最大50文字
| 試合詳細リスト | matches | List<TeamMatchDetailDto> | 必須、5件
|===

==== TeamMatchDetailDtoのフィールド定義

[cols="1,1,1,1", options="header"]
|===
| 論理名 | 物理名 | 型 | バリデーションルール

| ポジション | position | String | 必須（先鋒、次鋒、中堅、副将、大将）
| 赤選手名 | redPlayer | String | 任意、最大50文字
| 白選手名 | whitePlayer | String | 任意、最大50文字
| 勝敗 | result | String | 必須（"赤"、"白"、"引き分け"）
|===

=== CreateTeamMatchResponseDtoのフィールド定義

[cols="1,1,1,1", options="header"]
|===
| 論理名 | 物理名 | 型 | バリデーションルール

| 団体戦ID | teamMatchId | Long | 自動採番
|===

=== TeamMatchEntityのフィールド定義

[cols="1,1,1,1", options="header"]
|===
| 論理名 | 物理名 | 型 | バリデーションルール

| ID | id | Long | PK, AUTO_INCREMENT
| 大会ID | tournament_id | Long | FK(tournaments.id)
| ラウンド名 | round_name | String | NOT NULL
| 赤チーム名 | red_team_name | String | NOT NULL
| 白チーム名 | white_team_name | String | NOT NULL
| 登録日時 | created_at | Timestamp | 自動設定
|===

=== TeamMatchDetailEntityのフィールド定義

[cols="1,1,1,1", options="header"]
|===
| 論理名 | 物理名 | 型 | バリデーションルール

| ID | id | Long | PK, AUTO_INCREMENT
| 団体戦ID | team_match_id | Long | FK(team_matches.id)
| ポジション | position | String | NOT NULL
| 赤選手名 | red_player | String | 空可、最大50文字
| 白選手名 | white_player | String | 空可、最大50文字
| 勝敗 | result | String | NOT NULL
|===

== Controller定義

=== クラス名
TeamMatchController

=== アノテーション一覧

[cols="1,1", options="header"]
|===
| 対象 | アノテーション

| クラス | @RestController, @RequestMapping("/api")
| メソッド | @PostMapping("/team-matches")
|===

=== パラメータアノテーション一覧

[cols="1,1", options="header"]
|===
| パラメータ | アノテーション

| CreateTeamMatchRequestDto request | @RequestBody
|===

=== メソッド一覧

[cols="1,1,1", options="header"]
|===
| メソッド名 | 戻り値型 | パラメータ

| createTeamMatch | ResponseEntity<CreateTeamMatchResponseDto> | CreateTeamMatchRequestDto request
|===

=== 処理詳細

[cols="1,2", options="header"]
|===
| 番号 | 処理内容

| 1 | バリデーションを実行。不正があれば400エラーを返却。
| 2 | サービス層にリクエストDTOを渡して処理を委譲。
| 3 | 登録成功時は登録IDを含むレスポンスDTOを返却。
| 4 | エラー発生時は適切なステータスとメッセージを返却。
|===

== Service定義

=== クラス名
TeamMatchService

=== フィールド一覧

[cols="1,1,1", options="header"]
|===
| フィールド名 | 型 | 内容

| teamMatchMapper | TeamMatchMapper | 団体戦登録用マッパー
|===

=== メソッド：createTeamMatch

[cols="1,1,1", options="header"]
|===
| メソッド名 | 戻り値型 | パラメータ

| createTeamMatch | Long | CreateTeamMatchRequestDto request
|===

=== 処理詳細

[cols="1,2", options="header"]
|===
| 番号 | 処理内容

| 1 | request から TeamMatchEntity と List<TeamMatchDetailEntity> を作成
| 2 | team_match テーブルに insert（mapper）
| 3 | 生成された team_match_id をもとに、team_match_detail テーブルへ5件 insert
| 4 | 登録IDを返却
|===

== Repository定義

=== TeamMatchMapper（MyBatis XML）

[source,sql]
----
-- 団体戦全体の登録
INSERT INTO team_matches (
  tournament_id, round_name, red_team_name, white_team_name, created_at
) VALUES (
  #{tournamentId}, #{roundName}, #{redTeamName}, #{whiteTeamName}, NOW()
);

-- 登録ID取得
SELECT LAST_INSERT_ID();

-- 個別試合登録（5件ループ）
INSERT INTO team_match_detail (
  team_match_id, position, red_player, white_player, result
) VALUES (
  #{teamMatchId}, #{position}, #{redPlayer}, #{whitePlayer}, #{result}
);
----
